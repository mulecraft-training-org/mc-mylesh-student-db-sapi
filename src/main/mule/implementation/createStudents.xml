<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">

	<flow
		name="post:\students:application\json:student-management-api-config">
		<set-variable
			value="#[&quot;SELECT student_id FROM student_details WHERE email_id IN &quot;  &#10;++ ( &quot;(&quot; ++ ( payload.emailId map ((item)-&gt; &quot;'&quot; ++ item ++ &quot;'&quot; ) joinBy &quot;,&quot; ) ++  &quot;)&quot; )]"
			doc:name="Set Variable" doc:id="0c522017-75f3-47ce-9a50-8c84ee1a9ed0"
			variableName="emailId" />
		<logger level="INFO" doc:name="Logger"
			doc:id="c80b6f6d-1194-4663-9a27-cc97ab8b0970"
			message="#[vars.emailId]" />
		<db:bulk-insert doc:name="Bulk insert"
			doc:id="5e915b41-228f-4334-bf2f-3a5f3a25fac7"
			config-ref="Database_Config">
			<db:sql><![CDATA[INSERT INTO student_details
( first_name, last_name, school_name, email_id, trainer_id, enrollment_date, status, course_id)
VALUES ( :firstName, :lastName, :schoolName::schoolenum, :emailId, :trainerId, :enrollmentDate::date, :status::statusenum, :courseId)
]]></db:sql>
		</db:bulk-insert>
		<db:select doc:name="Select"
			doc:id="d1e19990-4ffb-4955-af9b-921e88bb18c8"
			config-ref="Database_Config">
			<db:sql><![CDATA[#[vars.emailId]]]></db:sql>
		</db:select>
		<logger level="INFO" doc:name="Logger"
			doc:id="489c42b8-587a-4326-a793-9b85b3fdbd84" message="#[payload]" />
		<ee:transform doc:name="Transform Message"
			doc:id="b56733d4-9b4f-40bc-b3f6-fe5cf198e4b5">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload.student_id map (
    {
        "studentId": $,
        "status": "request succeeded",
        "response":"student details created successfully"
    }
)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</flow>

</mule>
